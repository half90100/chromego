/*! 2014-12-19 11:12:26 */
KISSY.add("amazonFunction",function(a,b,c,d,e,f,g,h){function i(){i.superclass.constructor.apply(this,arguments),this.init()}return a.extend(i,b,{init:function(){var a=this;a.bindEvents(),a.initSearch(),a.initTag(),a.priceTip(),a.listPriceTip(),a.reposTips(),a.bindChangeEvent(),d.placeOrder(a.getPlaceOrderParam())},bindEvents:function(){var b=this;a.one("body").on("getShipAddressCallback",function(){d.generateAutoAddrList(window.Ali_Haitao.shipAddress,b.getAutoAddressInfo())})},reposTips:function(){var a=this;a.addrNotifyTip(),a.weightTransTips(),a.primeTips(),a.taxFreeTips(),a.giftTips(),a.shipSpeedTips(),d.shipAddressTips(a.getAutoAddressInfo())},getAutoAddressInfo:function(){var a={query:"#newShippingAddressFormFromIdentity",triangle:"bottom",x:70,y:-45,addressMap:{fullName:"#enterAddressFullName",fullAddress:"",fullZipCode:"#enterAddressPostalCode",firstName:"",lastName:"",address1:"#enterAddressAddressLine1",address2:"#enterAddressAddressLine2",zipCode:"",zipCodeLast:"",telephone:"#enterAddressPhoneNumber",province:"#enterAddressStateOrRegion",city:"#enterAddressCity"}};return a},listenCssChange:function(b,c){var d=null,f=a.all(b);if(f)for(var g=0;g<f.length;g++)new e(f[g],function(){d&&clearTimeout(d),d=setTimeout(function(){a.log("listenCssChange execute"),KISSY.one("body").fire("haitaoRepaint"),c&&c(),d=null},100)})},getLocalStorageWeight:function(a){var b="ali_weight_"+a;return localStorage[b]?localStorage[b]:"0"},setLocalStorageWeight:function(a,b){var c="ali_weight_"+a;localStorage[c]=b},getLocalStorageShip:function(a){var b="ali_shippingPrice_"+a;return localStorage[b]?localStorage[b]:"0"},setLocalStorageShip:function(a,b){var c="ali_shippingPrice_"+a;localStorage[c]=b},bindChangeEvent:function(){var b=this;a.one(document).delegate("change","#pagecontentplaceholder input[name='isGiftPurchase']",b.giftTips),a.one(document).delegate("change","#pagecontentplaceholder input[name='order_0_ShippingSpeed']",b.shipSpeedTips),b.listenCssChange("#cart-active-items .couponsavings .txtnormal~span")},shipSpeedTips:function(){function b(){var b="haitao_shipSpeedTips_1",c=a.one("#"+b);if(c&&c.remove(),a.one("#shippingOptionFormId")&&d.isVisible(a.one("#shippingOptionFormId"))){var e=a.one("#order_0_ShippingSpeed_PrimeSMSP-second");if(e&&"checked"==e.attr("checked"))return;var f=a.one("#order_0_ShippingSpeed_sss-us");if(f&&d.isVisible(f)&&"checked"!=f.attr("checked")){var g=d.getAbsolutePos(f,-145,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}else if(a.one("#shipoptionselectpagecontent")&&d.isVisible(a.one("#shipoptionselectpagecontent"))){var e=a.one("#order_0_ShippingSpeed_PrimeSMSP-second");if(e&&"checked"==e.attr("checked"))return;var f=a.one("#order_0_ShippingSpeed_sss-us");if(f&&d.isVisible(f)&&"checked"!=f.attr("checked")){var g=d.getAbsolutePos(f,342,-12);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"left",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}else if(a.one("#pagecontentplaceholder .shipping-speeds")&&d.isVisible(a.one("#pagecontentplaceholder .shipping-speeds"))){var f=a.one("#pagecontentplaceholder .shipping-speeds input[name='currentshippingspeed']");if(f&&"sss-us"!=f.attr("value")){var h=a.one("#pagecontentplaceholder .shipping-speeds input[value='sss-us']");if(h&&d.isVisible(h)){var g=d.getAbsolutePos(h,-145,-14);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}}else if(a.one("#custom-doc .shipping-speeds")&&d.isVisible(a.one("#custom-doc .shipping-speeds"))){var f=a.one("#custom-doc .shipping-speeds input[name='currentshippingspeed']");if(f&&"sss-us"!=f.attr("value")){var h=a.one("#custom-doc .shipping-speeds input[value='sss-us']");if(h&&d.isVisible(h)){var g=d.getAbsolutePos(h,-145,-14);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}}else if(a.one("#spcpagecontent .shipping-speeds")&&d.isVisible(a.one("#spcpagecontent .shipping-speeds"))){var f=a.one("#spcpagecontent .shipping-speeds input[name='selectedshipspeed0.0.0']");if(f&&d.isVisible(f)){var g=d.getAbsolutePos(f,-145,-8);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}else if(a.one("#spc-form .shipping-speeds")&&d.isVisible(a.one("#spc-form .shipping-speeds"))){var f=a.one("#spc-form .shipping-speeds input[name='order0']");if(f&&d.isVisible(f)&&"checked"!=f.attr("checked")){var g=d.getAbsolutePos(f,-145,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"免邮费，优先考虑！"},function(b){a.one("body").append(b)})}}}function c(){var b="haitao_shipSpeedTips_2",c=a.one("#"+b);if(c&&c.remove(),a.one("#shippingOptionFormId")&&d.isVisible(a.one("#shippingOptionFormId"))){var e=a.one("#shippingOptionFormId #order_0_ShippingSpeed_sss-us");if(e&&"checked"==e.attr("checked"))return;var f=a.one("#shippingOptionFormId #order_0_ShippingSpeed_PrimeSMSP-second");if(f&&d.isVisible(f)&&"checked"!=f.attr("checked")){var g=d.getAbsolutePos(f,-162,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"参加Prime才可免邮费！"},function(b){a.one("body").append(b)})}}else if(a.one("#shipoptionselectpagecontent")&&d.isVisible(a.one("#shipoptionselectpagecontent"))){var e=a.one("#shipoptionselectpagecontent #order_0_ShippingSpeed_sss-us");if(e&&"checked"==e.attr("checked"))return;var f=a.one("#shipoptionselectpagecontent #order_0_ShippingSpeed_PrimeSMSP-second");if(f&&d.isVisible(f)&&"checked"!=f.attr("checked")){var g=d.getAbsolutePos(f,675,-12);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"left",left:g.left,top:g.top,posAlign:"left",id:b,text:"参加Prime才可免邮费！"},function(b){a.one("body").append(b)})}}else if(a.one("#pagecontentplaceholder .shipping-speeds")&&d.isVisible(a.one("#pagecontentplaceholder .shipping-speeds"))){var e=a.one("#pagecontentplaceholder .shipping-speeds input[name='currentshippingspeed']");if(e&&"sss-us"==e.attr("value"))return;var f=a.one("#pagecontentplaceholder .shipping-speeds .primeAdLauncher");if(f&&d.isVisible(f)){var g=d.getAbsolutePos(f,-162,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"参加Prime才可免邮费！"},function(b){a.one("body").append(b)})}}else if(a.one("#custom-doc .shipping-speeds")&&d.isVisible(a.one("#custom-doc .shipping-speeds"))){var e=a.one("#custom-doc .shipping-speeds input[name='currentshippingspeed']");if(e&&"sss-us"==e.attr("value"))return;var f=a.one("#custom-doc .shipping-speeds .primeAdLauncher");if(f&&d.isVisible(f)){var g=d.getAbsolutePos(f,-162,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:g.left,top:g.top,posAlign:"left",id:b,text:"参加Prime才可免邮费！"},function(b){a.one("body").append(b)})}}}c(),b()},giftTips:function(){var b="haitao_giftTips_1",c=a.one("#"+b);c&&c.remove();var e=a.one("#pagecontentplaceholder input[name='isGiftPurchase']");if(e&&"checked"==e.attr("checked")){var f=d.getAbsolutePos(e,470,-10);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"left",left:f.right,top:f.top,posAlign:"left",id:b,text:"礼物包装？这不是免费的哦！"},function(b){a.one("body").append(b)})}},weightTransTips:function(){function b(b){if(b){var e="",f="",g=0,h=b.text().trim().toLowerCase(),i=h.substring(0,h.indexOf(" "));if(-1!=i.indexOf("pound"))g=parseFloat(i),e=g+"磅",f=" = 斤";else{if(-1==i.indexOf("ounce"))return g=parseFloat(i),void console.log("weight is not pounds nor ounces");g=parseInt(parseFloat(i)/16*100)/100,e=parseFloat(i)+"盎司",f=" = "+g+"磅 = "+parseInt(100*g/1.1)/100+"斤"}var j=d.getAbsolutePos(b,25,-8);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"left",left:j.right,top:j.top,posAlign:"left",id:c,text:"",textHtml:e,aftertext:f},function(b){a.one("body").append(b)})}}var c="haitao_weightTransTips_1",e=a.one("#"+c);if(e&&e.remove(),a.one("#newTwisterEVDD")){var f=a.one("#size_name_DonsBox_DonsBoxSelectedRowSelected"),g=a.one("#size_name_single"),h=null;f&&d.isVisible(f)?h=f:g&&d.isVisible(g)&&(h=g),b(h)}else if(a.one("#selected_size_name")){var f=a.one("#selected_size_name .variationLabel"),g=a.one("#selected_size_name .variationLabelHovered"),h=null;f&&d.isVisible(f)?h=f:g&&d.isVisible(g)&&(h=g),b(h)}},taxFreeTips:function(){var b="haitao_taxFreeTips_1",c=a.one("#"+b);c&&c.remove();var e=a.all("#SPCSubtotals-marketplace-table .label");if(e)for(var f=0;f<e.length;f++){var g=a.one(e[f]);if(-1!=g.text().indexOf("Estimated tax")&&d.isVisible(g)){var h=g.siblings(".price")?g.siblings(".price").text():"0";if(0==parseFloat(h.replace("$","")))return;var i=a.one("#purchase-shipping-address .displayAddressPhoneNumber");if(i){var j=i.text().replace(/\s/g,"").replace("Phone:","").replace(/-/g,"").replace(/\(/g,"").replace(/\)/g,"");if("6266892000"==j||"2125744908"==j||"6264154695"==j||"6262804888"==j){var k=d.getAbsolutePos(g,-15,-10);return void d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"right",left:k.left-240,top:k.top,posAlign:"left",id:b,text:"有消费税！建议在左侧改为免税州地址。"},function(b){a.one("body").append(b)})}}}}},primeTips:function(){var b="haitao_primeTips_1",c=a.one("#"+b);c&&c.remove();var e="haitao_prime_indicator",f=a.one("."+e);f&&f.remove();var g=a.one("#primeAdContent .primeButtons .ap_custom_close");if(g&&d.isVisible(g)){var h=d.getAbsolutePos(g,-325,-70);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"",left:h.left,top:h.top,posAlign:"left",id:b,style:"z-index:1000",text:"Prime 有免费2日送货服务，试用期过后不取消将收费。怕麻烦请选",textHtml:"No Thanks",aftertext:"！"},function(b){b+='<div class="'+e+'" style="left:'+(h.left+425)+"px;top:"+(h.top+15)+'px;z-index:1000"></div>',a.one("body").append(b)})}},listPriceTip:function(){function b(a){var b=0;if(a){var c=a.text().trim();b=parseInt(100*parseFloat(c.substring(c.indexOf("$")+1,c.length)))/100}return b}function c(b,c){var e="haitao_shipTips_"+b.attr("itemcount"),f=a.one("#"+e);if(f&&f.remove(),c&&"0"!=c&&0!=c){var g=b.children("#item-block");if(g&&""!=g.height()&&!(g.height()<80)){var h=d.getAbsolutePos(b,300,-35);d.generateTemplateHtml(window.Ali_Haitao.template.otherTips,{triangle:"bottom",left:h.left,top:h.top,posAlign:"left",id:e,text:"该商品有",textHtml:"$"+c,aftertext:"美国境内运费"},function(b){a.one("body").append(b)})}}}function e(){for(var d={shippingWeight:0,shipPrice:0,goodList:[]},e=a.all("#cart-active-items .cart-item"),f=0;f<e.length;f++){var g=a.one(e[f]),h=g.children("#item-block");if(h&&""!=h.height()&&!(h.height()<80)){var j=g.attr("itemcount"),k=a.one("#cart-active-items .cart-item[itemcount='"+j+"'] .couponsavings .txtnormal"),l=a.one("#cart-active-items .cart-item[itemcount='"+j+"'] .product-title a"),m=i.getLocalStorageWeight(g.attr("asin")),n=i.getLocalStorageShip(g.attr("asin"));d.goodList.push({asin:g.attr("asin"),name:l?l.text():"",singlePrice:g.attr("price").replace("$",""),quantity:g.attr("quantity"),shipPrice:n,shippingWeight:m,coupon:b(k)}),c(g,n),d.shippingWeight+=parseFloat(m)*g.attr("quantity"),d.shipPrice+=parseFloat(n)}}return d.shippingWeight=parseInt(100*d.shippingWeight)/100,d.shipPrice=parseInt(100*d.shipPrice)/100,d}function f(){var b=0,c=a.one("#cart-subtotal .ourprice");return c&&(b=parseInt(100*parseFloat(c.text().replace("$","").replace(",","")))/100),b}function g(){"true"==window.Ali_Haitao.isShowTips&&(k&&clearTimeout(k),k=setTimeout(function(){var b=d.getAbsolutePos(a.one("#cart-subtotal"),-20,0),c=e(),j=f(),l={triangle:"right",left:KISSY.one(document).width()-b.left,top:b.top,pos:"right",price:j,chinaPrice:parseInt(j*d.getCurrentRate()*100)/100,shippingWeight:c.shippingWeight,discount:0,shippingCost:c.shipPrice,quantity:1,currentRate:d.getCurrentRate(),goodList:c.goodList};0!=l.price?new h(l):new h(l,!0),i.listenCssChange("#cart-active-items .cart-item",g),k=null},100))}var i=this,j=(window.Ali_Haitao.config,a.one("#cart-subtotal"));if(j){var k=null;g(),a.one(document).delegate("DOMSubtreeModified","#cart-active-items",g)}},priceTip:function(){function b(a){var b={price:a||0,shippingCost:0,quantity:1,discount:0,shippingWeight:0},c=KISSY.one("#quantity");c&&(b.quantity=parseInt(c.val())),n.setLocalStorageShip(KISSY.one("#ASIN").attr("value"),"0");var d=KISSY.one("#pricePlusShippingQty .plusShippingText");if(d){var e=d.html(),f=e.indexOf("$");-1!=f&&(b.shippingCost=parseFloat(e.substring(f+1,e.length)),n.setLocalStorageShip(KISSY.one("#ASIN").attr("value"),b.shippingCost))}var g=KISSY.one("#clipped");if(g){var e=g.siblings(".qpHeadline").text(),f=e.indexOf("$");-1!=f&&(b.discount=parseFloat(e.substring(f+1,e.length)))}return b.shippingWeight=b.quantity*n.getShippingWeight(),b.shippingWeight_kg=parseInt(.45359237*b.shippingWeight*100)/100,b}function c(){if(actualPrice=KISSY.one("#priceBlock .priceLarge")||KISSY.one("#price_feature_div #priceblock_ourprice")){var a=parseFloat(actualPrice.text().trim().replace("$","").replace(",","")),c=b(a),e=d.getAbsolutePos(actualPrice,2,-8),f={triangle:"left",left:e.right,top:e.top,pos:"left",price:c.price,shippingWeight:c.shippingWeight,shippingWeight_kg:c.shippingWeight_kg,discount:c.discount,shippingCost:c.shippingCost,quantity:c.quantity,currentRate:d.getCurrentRate()};return f}}function e(){"true"==window.Ali_Haitao.isShowTips&&(p&&clearTimeout(p),p=setTimeout(function(){new f(c()),p=null},100))}function g(){q.delegate("change","#quantity",e),q.delegate("DOMSubtreeModified","#pricePlusShippingQty",e),q.delegate("DOMSubtreeModified","#buyBoxContent",e),q.delegate("DOMSubtreeModified","#handleBuy",e)}function h(){q.undelegate("change","#quantity",e),q.undelegate("DOMSubtreeModified","#pricePlusShippingQty",e),q.undelegate("DOMSubtreeModified","#buyBoxContent",e),q.undelegate("DOMSubtreeModified","#handleBuy",e)}function i(a){var b={price:a||0,shippingCost:0,quantity:1,discount:0,shippingWeight:0},c=KISSY.one("#selectQuantity .a-dropdown-prompt");c&&(b.quantity=parseInt(c.html())),n.setLocalStorageShip(KISSY.one("#ASIN").attr("value"),"0");var d=KISSY.one("#soldByThirdParty .shipping")||KISSY.one("#soldByThirdParty .shipping3P");if(d){var e=d.html(),f=e.indexOf("$");-1!=f&&(b.shippingCost=parseFloat(e.substring(f+1,e.length).replace(",","")),n.setLocalStorageShip(KISSY.one("#ASIN").attr("value"),b.shippingCost))}return c=KISSY.one("#selectQuantity #quantity"),c&&(b.quantity=parseInt(c.val())),b.shippingWeight=b.quantity*n.getShippingWeight(),b.shippingWeight_kg=parseInt(.45359237*b.shippingWeight*100)/100,b}function j(a){var b=i(a),c=d.getAbsolutePos(KISSY.one("#price_feature_div #priceblock_dealprice")||KISSY.one("#price_feature_div span[class*='a-size-']"),2,-8),b={triangle:"left",left:c.right,top:c.top,pos:"left",price:b.price,shippingWeight:b.shippingWeight,shippingWeight_kg:b.shippingWeight_kg,discount:b.discount,shippingCost:b.shippingCost,quantity:b.quantity,currentRate:d.getCurrentRate()};return b}function k(){r.detach("DOMSubtreeModified",l),r.on("DOMSubtreeModified",l)}function l(){clearTimeout(l.timer),l.timer=setTimeout(function(){m(),KISSY.one("body").fire("haitaoRepaint")},50)}function m(){"true"==window.Ali_Haitao.isShowTips&&(s&&clearTimeout(s),s=setTimeout(function(){var a=KISSY.one("#price_feature_div #priceblock_dealprice")||KISSY.one("#price_feature_div span[class*='a-size-']");if(a){var b=a.text().split("$");2==b.length?(r.detach("DOMSubtreeModified"),new f(j(b[1].replace(",",""))),k()):new f(null,!0)}s=null},100))}var n=this,o=(window.Ali_Haitao.config,KISSY.one("#priceBlock")||KISSY.one("#price_feature_div"));if(o){var p=null,q=a.one(document);e(),h(),g()}else{var r=KISSY.one("#price_feature_div");if(!r)return;var s=null;k(),m(),a.one(document).delegate("change","#selectQuantity #quantity",m),a.one(document).delegate("DOMSubtreeModified","#selectQuantity .a-dropdown-prompt",m),a.one(document).delegate("DOMSubtreeModified","#soldByThirdParty",m)}},getShippingWeight:function(){var a=this,b=KISSY.one('a[href*="/gp/help/seller/shipping.html"]'),c=0;if(b&&b.parent()){var d=b.parent().text(),e=d.substring(d.indexOf(":")>0?d.indexOf(":")+1:0,d.indexOf("(")>0?d.indexOf("("):d.length).trim();d.indexOf("（")>0&&(e=d.substring(d.indexOf("：")>0?d.indexOf("：")+1:0,d.indexOf("（")>0?d.indexOf("（"):d.length).trim()),c=-1!=e.indexOf("pounds")||-1!=e.indexOf("磅")?parseFloat(e):-1!=e.indexOf("ounces")||-1!=e.indexOf("盎司")?parseInt(parseFloat(e)/16*100)/100:parseFloat(e)}return isNaN(c)&&(c=0),a.setLocalStorageWeight(KISSY.one("#ASIN").attr("value"),c),c},generatePriceTrend:function(){var a="";if("www.amazon.com"==window.location.host){var b=window.location.pathname,c=(b.indexOf("/ref="),KISSY.one("#ASIN").attr("value")),d="http://charts.camelcamelcamel.com/us/"+c+"/amazon.png?force=1&zero=0&w=500&h=300&desired=false&legend=1&ilt=1&tp=all&fo=0";a='<a target="blank" href="http://camelcamelcamel.com/product/'+c+'">    <img src="'+d+'"</a>';var e=new Image;e.src=d}return a},initTag:function(){return},getPlaceOrderParam:function(){return[{orderButton:"#buybutton input[name='placeYourOrder']",priceQuery:"#SPCSubtotals-marketplace .total .price",type:"pay"},{orderButton:"#right-grid input[name='placeYourOrder1']",priceQuery:"#subtotals-marketplace-table .a-color-price.a-text-right",type:"pay"},{orderButton:"#gutterCartViewForm input[name='proceedToCheckout']",priceQuery:"#cart-subtotal .ourprice",type:"cart"}]},addrNotifyTip:function(){"/"==window.location.pathname&&d.showAddrNotify()},initSearch:function(){new g("#twotabsearchtextbox",-9,6,function(a){window.location.href="http://www.amazon.com/s/ref=nb_sb_noss_1?url=search-alias%3Daps&field-keywords="+a})}},{ATTRS:{}}),i},{requires:["base","node","haitaoUtils","listenCssChange","haitaoGoodPrice","haitaoSearchTrans","haitaoListPrice"]});