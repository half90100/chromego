/*! 2014-12-19 11:12:26 */
KISSY.add("haitaoGoodPrice",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,b){var c=this;c.data=a,c.destroy=b,c.init()}var m=new g,n=null,o=null,p="#haitao_single_price";return a.extend(l,b,{init:function(){var b,c=this,d=c.data,e=c.destroy,f=a.one("#haitao_single_price");f&&(f.hasClass("haitao_unfold")&&(d.unfold="haitao_unfold"),f.remove()),!e&&d&&(n=KISSY.clone(d),b=m.generateData(n),c.set("htmlData",b),b.website=getMatchedWebSiteDomain(),c._render(b),c.setPromptStatus(b),c.generatePriceTrendHtml(),c.initWeightTip(n.shippingWeight),c._bindEvents(d),c.initNewFeatureTip(),c._initWeightInput(n),c._initSelect(b))},_bindEvents:function(){var b=this;b.unbindEvent(),KISSY.one(p+" .haitao_tips_title").on("click",function(a){var c=KISSY.one(a.target);c.hasClass("haitao_price_trend")||(KISSY.one(p).toggleClass("haitao_unfold"),KISSY.one(p).hasClass("haitao_unfold")?(b.showShipComptip(),KISSY.one("#haitao_single_price .haitao_update_weight").fire("focus")):b.closeShipComptip())}),KISSY.one(document).on("click",b.toggleGoodPrice,b);var c=KISSY.one(".haitao_font .haitao_tips_trend");KISSY.Event.delegate(document,"mouseenter",".haitao_font .haitao_price_trend",function(){var a=KISSY.one(".haitao_price_trend").offset().left-KISSY.one("#haitao_single_price").offset().left-2;a=0,c.css("left",0),c.css("visibility","visible"),c.show()}),KISSY.Event.delegate(document,"mouseleave",".haitao_font .haitao_price_trend",function(a){var b=KISSY.one(a.relatedTarget);b.hasClass("haitao_tips_trend")?c.show():c.hide()}),KISSY.Event.delegate(document,"mouseleave",".haitao_font .haitao_tips_trend",function(a){var b=KISSY.one(a.relatedTarget);b.hasClass("haitao_price_trend")?c.show():c.hide()}),KISSY.Event.delegate(document,"click",".haitao_font .haitao_compare_ship_btn",function(){new k}),KISSY.Event.delegate(document,"click",".haitao_newFeature_shipComp_close",b.closeShipComptip,b),a.one("body").on("EV_COMPANYCHANEL_SYNC",function(a){var c=b.get("htmlData");m.setSelect(c,a.company,a.channel)})},unbindEvent:function(){var a=this;KISSY.Event.detach(p+" .haitao_tips_title","click"),KISSY.Event.detach(p+" .haitao_tips_title","click",a.toggleGoodPrice),KISSY.Event.undelegate(document,"mouseenter",".haitao_font .haitao_price_trend"),KISSY.Event.undelegate(document,"mouseleave",".haitao_font .haitao_price_trend"),KISSY.Event.undelegate(document,"mouseleave",".haitao_font .haitao_tips_trend"),KISSY.Event.undelegate(document,"click",".haitao_font .haitao_compare_ship_btn"),KISSY.Event.undelegate(document,"click",".haitao_newFeature_shipComp")},_render:function(a){var b=f.to_html(window.Ali_Haitao.template.priceDetail,a);KISSY.one("body").append(b)},_initSelect:function(a){var b=this;m.initSelect("#haitao_single_price .haitao_sel_transComp",a,function(a,c){o=c,b.repaintPricePanel(a),console.log(m)})},_initWeightInput:function(a){var b=this;new i("#haitao_single_price .haitao_update_weight",function(c){a.shippingWeight=parseFloat(c),b.initWeightTip(a.shippingWeight),b.repaintPricePanel(m.calPrice(a,o)),b.showShipComptip()})},showShipComptip:function(){var a=localStorage.ali_haitao_new_feature_shipComp;if(!a||"true"!=a){var b=KISSY.one(".haitao_newFeature_shipComp");if(b){var c=KISSY.one(".haitao_compare_ship_btn");if(c){var d=c.offset();b.css({left:d.left-67,top:d.top-140}),b.show()}}}},closeShipComptip:function(){KISSY.one(".haitao_newFeature_shipComp")?KISSY.one(".haitao_newFeature_shipComp").remove():"",KISSY.one(".haitao_newFeature_flag")?KISSY.one(".haitao_newFeature_flag").remove():"",localStorage.ali_haitao_new_feature_shipComp="true"},toggleGoodPrice:function(a){var b=this;if(KISSY.one(p)){var c=KISSY.one(a.target).parent(p),d=KISSY.one(a.target).hasClass("haitao-menu")||KISSY.one(a.target).parent(".haitao-menu"),e=KISSY.one(a.target).hasClass("haitao_dialog_shipCompare")||KISSY.one(a.target).parent(".haitao_dialog_shipCompare"),f=KISSY.one(a.target).hasClass("haitao_newFeature_shipComp")||KISSY.one(a.target).parent(".haitao_newFeature_shipComp");if(c||d||e||f)return;KISSY.one(p).hasClass("haitao_unfold")&&(KISSY.one(p).removeClass("haitao_unfold"),b.closeShipComptip())}},setPromptStatus:function(a){"true"==a.specialProm?(KISSY.one(".haitao_detail_prompt_spec").show(),KISSY.one(".haitao_detail_prompt_normal").hide()):(KISSY.one(".haitao_detail_prompt_spec").hide(),KISSY.one(".haitao_detail_prompt_normal").show())},generatePriceTrendHtml:function(){var a=this,b=KISSY.one(".haitao_font .haitao_tips_trend"),c=KISSY.one("#ASIN")?KISSY.one("#ASIN").attr("value"):"";"www.haiwen.com"==location.host&&(c="B0009IWDGC"),""==c?b.html('<div class="haitao_trend_empty">暂时没有数据</div>'):a.calEtaoPriceTrend(c)},calEtaoPriceTrend:function(a){function b(b){var d=KISSY.one(".haitao_font .haitao_tips_trend");try{var e="object"==typeof b?b:JSON.parse(b);if(!e||0!=e.resultCode)throw new Error("Call Etao Price Trend Data Error!");d.html('<div id="haitao_etao_trend"></div><div class="haitao_etao_text"></div>'),new h(e.data.price_curve,"#haitao_etao_trend",".haitao_etao_text")}catch(f){d.html('<img class="haitao_camel_img" src="'+c.getCamelImg(a)+'" />')}}var c=this,d=encodeURIComponent("http://www.amazon.com/dp/"+a);if("www.haiwen.com"==location.host){var e={resultCode:0,msg:"成功",data:{price_type:3,price_curve:[{"2013-1-15":151.2},{"2013-2-15":189},{"2013-6-18":133.02},{"2013-6-25":151.01},{"2013-8-30":99.02}]}};setTimeout(function(){b(e)},1e3)}else KISSY.io.get("http://haiwai.etao.com/ajax/price_curve.htm?link="+d,function(a){b(a)})},initWeightTip:function(a){0==a?(KISSY.one("#haitao_single_price .haitao_bz_zerotip")?KISSY.one("#haitao_single_price .haitao_bz_zerotip").show():"",KISSY.one("#haitao_single_price .haitao_bz_kgtip")?KISSY.one("#haitao_single_price .haitao_bz_kgtip").hide():""):(KISSY.one("#haitao_single_price .haitao_bz_zerotip")?KISSY.one("#haitao_single_price .haitao_bz_zerotip").hide():"",KISSY.one("#haitao_single_price .haitao_bz_kgtip")?KISSY.one("#haitao_single_price .haitao_bz_kgtip").show():"")},initNewFeatureTip:function(){var a=localStorage.ali_haitao_new_feature_shipComp;if(!a||"true"!=a){var b=KISSY.one("#haitao_single_price .haitao_tips_title");b.append('<a href="javascript:void(0);" title="新功能来啦！" class="haitao_newFeature_flag"></a>'),KISSY.one("body").append('<div class="haitao_newFeature_shipComp haitao_font"><div class="haitao_newFeature_shipComp_close"></div></div>')}},repaintPricePanel:function(a){var b=this;KISSY.one("#haitao_single_price .haitao_total_price").html(a.totalPrice),KISSY.one("#haitao_single_price .haitao_ship_price").html(a.shippingCompanyCost),KISSY.one("#haitao_single_price .haitao_ship_singlePrice").html(a.moneyUnit+a.singlePrice),KISSY.one("#haitao_single_price .haitao_ship_extendPrice").html(a.moneyUnit+a.extendPrice),KISSY.one("#haitao_single_price .haitao_bz_calShippingWeight").html(a.shippingCompanyWeight),KISSY.one("#haitao_single_price .haitao_update_weight").val(a.shippingWeight),KISSY.one("#haitao_single_price .haitao_bz_shippingWeight_kg").html(a.shippingWeight_kg),KISSY.all("#haitao_single_price .haitao_bz_prompt").html(a.promptText),KISSY.all("#haitao_single_price .haitao_etaoDiscount_img").html(a.haitaoText),KISSY.all("#haitao_single_price .haitao_specialPrice").html(a.haitaoText),KISSY.all("#haitao_single_price .haitao_etaoDiscount_img").removeClass("haitao_etaoDiscount_true haitao_etaoDiscount_false").addClass("haitao_etaoDiscount_"+a.isEtaoDiscount),b.setPromptStatus(a)},getCamelImg:function(a){var b="http://charts.camelcamelcamel.com/us/"+a+"/amazon.png?force=1&zero=0&w=420&h=225&desired=false&legend=1&ilt=1&tp=all&fo=0",c=new Image;return c.src=b,b}},{ATTRS:{data:{value:""},destroy:{value:""}}}),l},{requires:["base","node","event","menubutton","mu","haitaoTransShip","haitaoPriceTrend","haitaoWeightInput","overlay","haitaoShipCompareDialog"]});