/*! 2014-12-19 11:12:26 */
KISSY.add("haitaoPriceTrend",function(a,b,c,d,e){function f(a,b,c){var d=this;f.superclass.constructor.apply(d),d.set("data",a),d.set("renderId",b),d.set("priceTextId",c),d.init()}return a.extend(f,b,{init:function(){var a=this;a._initPriceText(),a._initChart(),a._bindEvents()},_bindEvents:function(){var a,b=this,c=b.get("lineChart"),d=b.get("paper"),e=52,f=30,g=340,h=168;c.on("stockChange",function(c){a=b.get("nodeList"),null!=a&&(a.remove(),a=null);var i=c.x,j=50;c.x<e+j&&(i=e+j),c.x>g+e-j&&(i=g+e-j),a=d.text(i,h+f,"<div class='haitao_etao_date'>日期："+c.dataInfo.x+"</div>"),b.set("nodeList",a)}),c.on("paperLeave",function(){a=b.get("nodeList"),null!=a&&(a.remove(),a=null),b.set("nodeList",a)})},_initPriceText:function(){var a,b=this,c=b.get("priceTextId");a=b.tidyData(),b.set("chartData",a),b.setPriceText(a,c)},tidyData:function(){var a,b,c,d,e,f,g=this,h=g.get("data");if(g.formatDate(),c=h.length){for(d=h[c-1][0],e=d-5184e6,a=0;a<h.length;a++)if(f=h[a][0],!(e>f)){if(f>e&&0!==a){f=e,b=[[g.timeToStr(e)],[h[a-1][1]]];break}b=[[g.timeToStr(h[a][0])],[h[a][1]]],a++;break}for(;a<h.length;a++)f+=864e5,b[1].push(h[a][0]!==f?h[--a][1]:h[a][1]),b[0].push(g.timeToStr(f));return b}},formatDate:function(){var a,b,c=this,d=c.get("data");for(a=0;a<d.length;a++)for(var e in d[a])b=e.split("-"),3!==b.length?d.splice(a--,1):(d[a][0]=new Date(parseInt(b[0],10),parseInt(b[1],10)-1,parseInt(b[2],10)).getTime(),d[a][1]=d[a][e]);var f=c.getZeroTime((new Date).getTime());f>d[d.length-1][0]&&d.push({0:f,1:d[d.length-1][1]});for(var g=f-5184e6,h=d.length-1;h>=0&&d[h][0]!=g;h--)if(d[h][0]<g){var i={0:g,1:d[h][1]};d.splice(0,h+1),d.unshift(i);break}},setPriceText:function(a,b){var c,d;if(a&&a[1])for(var e=a[1],f=0;f<e.length;f++)(!c||e[f]>c)&&(c=e[f]),(!d||e[f]<d)&&(d=e[f]);var g=KISSY.one(b);c&&d&&g.html("60天内最高价：￥"+c+"，最低价：￥"+d)},_initChart:function(){var a=this,b=a.get("renderId"),c=a.get("chartData"),d="#923f16",f=52,g=30,h=340,i=168,j=new e({renderTo:b,canvasAttr:{x:f,y:g,width:h,height:i},points:{attr:{r:0,type:"auto"},hoverAttr:{r:4,stroke:d,"stroke-width":2,fill:"#fff",type:"circle"}},colors:[{DEFAULT:d}],xGrids:{isShow:!1},yGrids:{isShow:!0,css:{border:"1px dashed"}},yLabels:{css:{marginLeft:"-2px","font-family":"Microsoft Yahei","font-size":"10px"}},xLabels:{css:{marginTop:"8px",marginLeft:"-5px","font-family":"Microsoft Yahei","font-size":"10px"},template:function(a,b){return a%30==0?b:""}},lineType:"straight",xAxis:{text:c[0]},comparable:!0,series:[{text:"价格",data:c[1]}],tip:{css:{padding:"2px 5px","border-radius":"3px","font-size":"12px","font-weight":"bold",background:"#fff","border-width":"2px",color:d},alignX:"center",alignY:"bottom",offset:{x:0,y:-15},template:function(a){return a.datas[0].text+"：$"+a.datas[0].y}}}),k=j.getHtmlPaper();k.lineY(h/2+f,g,i).css({"border-left":"1px solid #ccc"}),k.lineY(h+f,g,i).css({"border-left":"1px solid #ccc"});a.set("lineChart",j),a.set("paper",k)},getZeroTime:function(a){var b=a?new Date(a):new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate());return c.getTime()},timeToStr:function(a){var b,c,d,e;return b=new Date(a),c=b.getFullYear(),d=b.getMonth()+1,e=b.getDate(),c+"."+(d>9?"":"0")+d+"."+(e>9?"":"0")+e}},{ATTRS:{lineChart:{value:null},chartData:{value:null}}}),f},{requires:["base","node","event","gallery/kcharts/1.3/linechart/index"]});