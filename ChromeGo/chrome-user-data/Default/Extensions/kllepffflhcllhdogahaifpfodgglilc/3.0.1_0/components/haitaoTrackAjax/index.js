/*! 2014-12-19 11:12:26 */
KISSY.add("haitaoTrackAjax",function(a,b,c,d,e){function f(){}return a.extend(f,b,{trackListObj:{trackList:[]},resetTrackList:function(){return{trackList:[]}},getTrackList:function(){var a=this;if(localStorage.haitao_trackList)if(haitaoRuntime&&"background"==haitaoRuntime){a.trackListObj=a.resetTrackList();var b=JSON.parse(localStorage.haitao_trackList||null);if(b)for(var c in b)a.trackListObj.trackList=a.trackListObj.trackList.concat(b[c].trackList)}else{if(a.trackListObj&&a.trackListObj.trackList&&a.trackListObj.trackList.lenth>0)return a.trackListObj;a.trackListObj=a.resetTrackList();var d=a.getAccountId();if(null!=d){var b=JSON.parse(localStorage.haitao_trackList||"{}");b&&b[d]&&(a.trackListObj=b[d])}}return a.setBadgeText(),a.trackListObj},setTrackListTimeout:null,setTrackList:function(){var a=this;haitaoRuntime&&"background"==haitaoRuntime?(a.setTrackListTimeout&&clearTimeout(a.setTrackListTimeout),a.setTrackListTimeout=setTimeout(function(){a.setTrackListTimeout=null,a.setTrackListDetail()},1e3)):a.setTrackListDetail()},setTrackListDetail:function(){var a=this,b=JSON.parse(localStorage.haitao_trackList||"{}")||{};if(haitaoRuntime&&"background"==haitaoRuntime){for(var c=a.trackListObj.trackList,d=0;d<c.length;d++){var e=c[d];for(var f in b)for(var g=0;g<b[f].trackList.length;g++)if(b[f].trackList[g].shipNum==e.shipNum){b[f].trackList[g]=e;break}}localStorage.haitao_trackList=JSON.stringify(b)}else{var h=a.getAccountId();null!=h&&(b[h]=a.trackListObj,localStorage.haitao_trackList=JSON.stringify(b))}a.setBadgeText(),a.sendTransTimeStat()},getDateFormatYYYYMMDD:function(a){var b=new Date(1e3*a),c=b.getMonth()+1;return b.getFullYear()+"-"+c+"-"+b.getDate()},sendTransTimeStat:function(){var a=this,b=JSON.parse(localStorage.haitao_trackList||"{}")||{};for(var c in b)for(var d=0;d<b[c].trackList.length;d++){var e=b[c].trackList[d];if(!e.hasSendStat&&e.t1&&e.t2&&e.t3&&e.t4){e.hasSendStat=1;var f={comp:e.transComp,order:e.shipNum,t1:a.getDateFormatYYYYMMDD(e.t1),t2:a.getDateFormatYYYYMMDD(e.t2),t3:a.getDateFormatYYYYMMDD(e.t3),t4:a.getDateFormatYYYYMMDD(e.t4)};KISSY.use("io",function(a,b){b.get("http://haiwai.etao.com/ajax/shenqi_time_gather.htm",f)})}}localStorage.haitao_trackList=JSON.stringify(b)},setBadgeText:function(){for(var a=this,b=0,c=a.trackListObj.trackList,d=0;d<c.length;d++){var f=c[d];""!=f.shipStatusRemind&&b++}e.setPopupBadgeText(b)},getShipStatusShort:function(a,b){var c=b||16;return a>c?a.substring(0,c-2)+"...":a},getAccountId:function(){var a=JSON.parse(localStorage.haitao_login);return a&&"true"==a.login?a.unb:null},delFromTrackList:function(a){var b=this,c=getAccountId();if(null!=c)for(var d=0;d<b.trackListObj.trackList.length;d++)if(b.trackListObj.trackList[d].shipNum==a){b.trackListObj.trackList.splice(d,1),b.setTrackList(),KISSY.one(".haitao_shipList")?KISSY.one(".haitao_shipList").fire("trackChange"):"";break}},addToTrackList:function(a,b){for(var c=this,d=!1,e=0;e<c.trackListObj.trackList.length;e++)if(c.trackListObj.trackList[e].shipNum==a.shipNum){d=!0,b&&(c.trackListObj.trackList[e]=a);break}d||c.trackListObj.trackList.push(a),c.setTrackList(),KISSY.one(".haitao_shipList")?KISSY.one(".haitao_shipList").fire("trackChange"):""},getShipStatus:function(a){var b=this,c=!1,d=localStorage.haitao_lastestTrackTime;if(a||!d)c=!0;else{var e=new Date,f=e.getTime()-parseFloat(d),g=1e3*parseInt(localStorage.haitao_trackInterval||1)*60*60;f>=g&&(c=!0)}if(c){localStorage.haitao_lastestTrackTime=(new Date).getTime();var h=b.getTrackList();if(h&&h.trackList&&h.trackList.length>0)for(var i=0;i<h.trackList.length;i++){var j=h.trackList[i];"1"!=j.shipStatus?b.getShipStatusAjax(j,function(){b.getTransferNumAjax()}):b.getTransferNumAjax()}}},getTransferNumAjaxTimeout:null,getTransferNumAjax:function(){var a=this;a.getTransferNumAjaxTimeout&&clearTimeout(a.getTransferNumAjaxTimeout),a.getTransferNumAjaxTimeout=setTimeout(function(){function b(b,c){function d(b){var d=a.getAccountId();if(null!=d){var e="object"==typeof b?b:JSON.parse(b),f=e?e[c.listName]:[];if(f&&f.length>0)for(var g=0;g<f.length;g++)for(var h=f[g],i=0;i<a.trackListObj.trackList.length;i++){var j=a.trackListObj.trackList[i];if(j.shipNum==h[c.shipNumber]){j.transCompStatus=h[c.status].toString(),j.shipStatusRemind="";var k=h[c.status].toString();if(""!=h[c.inlandNumber].trim()&&(j.transShipNum=h[c.inlandNumber],j.transShipComp=a.matchTransShipComp(h[c.inlandCompany]||c.inlandCompanyDef),""!=j.transShipNum&&(j.transShipNumTrue="true"),k==c.shipFromTransfer)){var l=h[c.shipMessage];j.transShipStatusText=l,j.transShipStatusShort=a.getShipStatusShort(l),l.indexOf("收寄")>=0&&l.indexOf("广州")>=0&&(j.shipStatusRemind="clear")}k==c.forecast?j.shipStatusRemind="forecast":k==c.delivery?j.shipStatusRemind="delivery":k==c.shipFromTransfer&&(j.shipStatusRemind="",j.transShipStatusShort="已签收",j.transShipStatusText="已签收");break}}a.setTrackList(),a.getTransferStatus()}}KISSY.use("io",function(a,e){e.get(c.url.replace("$$queryString$$",b.join(c.joinString)),function(a){d(a)})})}a.getTransferNumAjaxTimeout=null;var c={},d=a.getTrackList();if(d&&d.trackList&&d.trackList.length>0)for(var e=0;e<d.trackList.length;e++){var f=d.trackList[e];"other"!=f.transComp&&"true"!=f.transShipNumTrue&&(c[f.transComp]||(c[f.transComp]=[]),c[f.transComp].push(f.shipNum))}var g={youjia:{id:"youjia",url:'http://api.youjiaus.net/app/transit/resource/transit?format=json&requestdata={"UserName":"wwwetaocom","Token":"c37145e329405ee0cb48fb07e9d075d6","TrackType":1,"TrackingList":["$$queryString$$"]}',listName:"TrackingList",status:"Status",shipNumber:"TrackingNumber",inlandNumber:"PackageNumber",inlandCompany:"PackageCompany",inlandCompanyDef:"ems",forecast:"0",delivery:"2",shipFromTransfer:"notSupport",shipMessage:"Message",joinString:'","'},banma:{id:"banma",url:'http://api.360banma.com/etao/get_trans_info?format=json&requestdata={%22Token%22:%221c0d7db2b7ed8ed8%22,%22TrackType%22:1,%22UserName%22:%22etao_zebra_2013%22,%22TrackingList%22:["$$queryString$$"]}',listName:"TrackingList",status:"Status",shipNumber:"TrackingNumber",inlandNumber:"PackageNumber",inlandCompany:"TransCompany",inlandCompanyDef:"ems",forecast:"a",delivery:"c",shipFromTransfer:"f",shipMessage:"Message",joinString:'","'},disifang:{id:"disifang",url:"http://tr.4px.com/transport/TransportStatusSearch.aspx?key=KOXIALEU&code=$$queryString$$",listName:"results",status:"status",shipNumber:"request",inlandNumber:"tracking_no_in_china",inlandCompany:"logistics_company",inlandCompanyDef:"ems",forecast:"NO_RECORD",delivery:"NEED_USER_HANDLE",shipFromTransfer:"notSupport",shipMessage:"notSupport",joinString:","},baitong:{id:"baitong",url:"http://api.buytong.com/SearchTransportStatus/?key=HAIWAIETAO&code=$$queryString$$",listName:"results",status:"status",shipNumber:"request",inlandNumber:"tracking_no_in_china",inlandCompany:"logistics_company",inlandCompanyDef:"ems",forecast:"NO_RECORD",delivery:"NEED_USER_HANDLE",shipFromTransfer:"notSupport",shipMessage:"notSupport",joinString:","}};for(var h in c){console.log("-------comp",h);var i=c[h],j=g[h];b(i,j)}},1e3)},getTransferStatus:function(){var a=this,b=a.trackListObj;if(b&&b.trackList&&b.trackList.length>0)for(var c=0;c<b.trackList.length;c++){var d=b.trackList[c];if("true"==d.transShipNumTrue&&"other"!=d.transComp){if("banma"==d.transComp)continue;a.getTransferStatusAjax(d),KISSY.one(".haitao_shipList")?KISSY.one(".haitao_shipList").fire("trackChange"):""}}else KISSY.one(".haitao_shipList")?KISSY.one(".haitao_shipList").fire("trackChange"):""},getTransferStatusAjax:function(a){function b(b){var d="object"==typeof b?b:JSON.parse(b);if(0==d.code){if(1==d.status)a.transShipStatusShort="已签收",a.transShipStatusText="已签收",a.shipStatusRemind="",a.t3=d.progress[0].time,a.t4=d.progress[d.progress.length-1].time;else{var e=d.progress;if(e&&e.length>0){var f=decodeURI(e[e.length-1].text);a.transShipStatusText=f,a.transShipStatusShort=c.getShipStatusShort(f),f.indexOf("收寄")>=0&&f.indexOf("广州")>=0&&(a.shipStatusRemind="clear")}}c.addToTrackList(a,!0)}}console.log("itemObjAfterMatch-",a.transShipComp,":",a.transShipNum);var c=this,d="http://api1.hai0.com/kd.php?key=G00TBPg9aKAAjXZtfFeA&id="+a.transShipComp+"&num="+a.transShipNum;KISSY.use("io",function(a,c){c.get(d,function(a,c){"success"==c&&b(a)})})},matchTransShipComp:function(a){a=a.toLocaleLowerCase();var b="null";return a.match("韵达")?b="yunda":a.match("申通")?b="stsd":a.match("圆通")||a.match("YT")?b="ytsd":a.match("顺丰")?b="sf":a.match("速尔")?b="suer":a.match("ems")?b="ems":a.match("fedex")?b="fedex":a.match("dhl")?b="dhl":a.match("ups")?b="ups":a.match("usps")&&(b="usps"),b},getShipStatusAjax:function(a,b){var c=this,d="http://api1.hai0.com/kd.php?key=G00TBPg9aKAAjXZtfFeA&id="+a.shipComp+"&num="+a.shipNum;KISSY.use("io",function(e,f){f.get(d,function(d,e){if("success"==e){var f="object"==typeof d?d:JSON.parse(d);if(0==f.code){if(a.shipStatus=f.status,1==f.status)a.shipStatusText="已签收",a.t1=f.progress[0].time,a.t2=f.progress[f.progress.length-1].time;else{var g=f.progress;g.length>0&&(a.shipStatusText=decodeURI(g[g.length-1].text))}var h=16;a.shipStatusShort=a.shipStatusText.length>h?a.shipStatusText.substring(0,h-2)+"...":a.shipStatusText,c.addToTrackList(a,!0)}}b()})})}}),f},{requires:["base","node","io","haitaoUtils"]});