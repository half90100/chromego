/*! 2014-12-19 11:12:26 */
KISSY.add("haitaoTransShip",function(a,b,c,d,e){function f(){}return a.extend(f,b,{sel_company:null,sel_channel:null,hasHaitaoke:function(a){a=a||[];for(var b=0;b<a.length;b++)if("海淘客"==a[b].name)return!0;return!1},restructureShipJson:function(a){if(!(window.Ali_Haitao.shippingList&&window.Ali_Haitao.shippingList.length>0)){var b=[];for(var c in a.shipCompany){var d=a.shipCompany[c];if("haitaoke"!=d.id){var e=d.lines;for(var f in e)e[f].defaultShip&&"selected"==e[f].defaultShip&&(window.Ali_Haitao.defaultShip=e[f]),b.push(e[f]),window.Ali_Haitao.shipping[e[f].id]=e[f]}}window.Ali_Haitao.shippingList=b}},setSelect:function(b,c,d){var f=this;f.sel_company.set("selectedIndex",["youjia","disifang","banma","baitong"].indexOf(c));var g=b.shipCompany[c];f.sel_channel.removeItems(!0),a.each(g.lines,function(a){f.sel_channel.addItem(new e.Option({value:a.id,prefixCls:"haitao-",content:a.name}))}),f.sel_channel.set("selectedIndex",parseInt(d)-1),f.sel_channel.fire("click")},initSelect:function(b,c,d){function f(b){b||(b=j);var c=h[b];n.removeItems(!0),a.each(c.lines,function(a){n.addItem(new e.Option({value:a.id,prefixCls:"haitao-",content:a.name}))}),n.set("value",c.lines[0].id),n.fire("click")}var g=this,h=c.shipCompany,i=new e.Select({render:".haitao_sel_transComp",prefixCls:"haitao-",width:100,menu:{offset:[0,-1]}}),j=h.youjia.id,k=[];for(var l in h)"youjia"===l?k.splice(0,0,l):k.push(l);for(var m=0;m<k.length;m++){var l=k[m];i.addItem(new e.Option({value:h[l].id,prefixCls:"haitao-",content:h[l].name}))}i.set("value",k[0]),i.render(),g.sel_company=i;var n=new e.Select({prefixCls:"haitao-",width:140,render:".haitao_sel_transChannel",menu:{offset:[0,-1]}});i.on("click",function(a){var b=a.target.get("value");f(b)}),n.on("click",function(a){var b=a.target.get("value"),e=window.Ali_Haitao.shipping[b];d(g.calPrice(c,e),e)}),f(),n.render(),g.sel_channel=n},initSelect2:function(a,b,c){var d={width:selectWidth,prefixCls:"haitao-",menuCfg:{align:{offset:[0,-1]},height:150,elStyle:{width:selectWidth,overflow:"auto",overflowX:"hidden"},matchElWidth:!0}},f=this,g=e.Select.decorate(a,d);g.on("click",function(){var a=window.Ali_Haitao.shipping[g.get("value")];c(f.calPrice(b,a),a)})},getShippingPrice:function(a,b){if(b){var c=a.shippingWeight,d=parseFloat(b.minWeight),e=parseFloat(b.singleWeight),f=parseFloat(b.extendWeight),g=parseFloat(b.singlePrice),h=b.extendPrice,i="0"!=b.exchangeRate?parseFloat(b.exchangeRate):a.currentRate,j=0,k=0;if(0!=c){d>c&&(c=d);var l=c-e,m=Math.ceil(l/f);j=parseInt(100*(e+m*f))/100;var k=g;if(-1==h.indexOf("-"))k+=m*parseFloat(h*f);else{var n=h.split("-"),o=n.length;if(o>=m)for(var p=0;m>p;p++)k+=parseFloat(n[p]);else{for(var p=0;o>p;p++)k+=parseFloat(n[p]);k+=(m-o)*n[o-1]}}k=parseInt(k*i*100)/100}return{shippingCompanyWeight:j,shippingCompanyPrice:k}}},calPrice:function(a,b){function c(a){return parseInt((a.price*a.quantity-a.discount+a.shippingCost)*a.currentRate*100)/100}var d=c(a),e=this.getShippingPrice(a,b);return a.price_rmb=parseInt(a.price*a.currentRate*100)/100,a.shippingCost_rmb=parseInt(a.shippingCost*a.currentRate*100)/100,a.discount_rmb=parseInt(a.discount*a.currentRate*100)/100,a.totalPrice=parseInt(100*(d+(e&&e.shippingCompanyPrice)))/100,a.shippingCompanyCost=e&&e.shippingCompanyPrice,a.shippingCompanyWeight=e&&e.shippingCompanyWeight,a.shippingWeight_kg=parseInt(.45359237*a.shippingWeight*100)/100,a.singlePrice=b.singlePrice,a.extendPrice=parseInt(100*parseFloat(b.extendPrice))/100,a.promptText=b.promptText,a.haitaoText=b.haitaoText,a.isEtaoDiscount=b.isEtaoDiscount,a.specialProm=b.specialProm,a.moneyUnit="1"==b.exchangeRate?"￥":"$",a},generateData:function(a){var b=window.Ali_Haitao.template.shipping,c={};return c="object"==typeof b?b:JSON.parse(b),delete c.shipCompany.haitaoke,this.restructureShipJson(c),a.shipCompany=c.shipCompany,a.shipList=window.Ali_Haitao.shippingList,this.calPrice(a,window.Ali_Haitao.defaultShip)}}),f},{requires:["base","node","event","menubutton"]});